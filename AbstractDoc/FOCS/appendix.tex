%!TEX root = focs.tex

\section{Additional Material and Proofs}
\label{sec-appendix}

\subsection{A formal definition of the default strategy}
\label{sec-def-default}

The following is the definition of the default strategy $\df_p$ for a player $p \in \bP$. If $\bchain(q)$ is defined, then $\df_p(q) = \mine(p,\bchain(q),q)$. Otherwise, for every block $b \in \longest(q)$, let $v_{b}$ be the reward for player $p$ in the chain from the genesis block to the block $b$, that is,
\begin{eqnarray*}
v_{b} & = & r_p(\{b' \in q \mid b' \preceq b\}).
\end{eqnarray*}
Moreover, let $b^\star$ be the element in $\longest(q)$ maximising the values $v_{b}$ (if more than one such values exist, then $b^\star$  is defined as the first of such elements in the lexicographic order induced by the order $0 < 1 < \cdots < m-1$). Then we have that $\df_p(q) = \mine(p,b^\star,q)$.
Thus, a player following the default strategy tries to mine upon the final block that appears in the blockchain of $q$. If the blockchain in state $q$ does not exist, meaning that there are al least two longest paths from the genesis block, then the player will mine on the final block of one of these paths according to her rewards in them (she will choose the one that maximizes her reward). Finally, define the combined strategy $\df$ as $(\df_0,\df_1,\dots,\df_{m-1})$. 


\subsection{Two properties of greedy strategies}
\label{sec-char-states-greedy}

Under greedy strategies, players refrain to fork on top of blocks that appear before their latest block.
%, or their latest block in the blockchain. 
The consequence of using 
greedy strategies is that every state 
%a game 
under greedy strategies cannot have more than $m$ paths contesting for the blockchain. This is captured by the following lemma.
\begin{mylem}\label{lem-length-greedy}
Let $\bs$ be a greedy strategy. Then for every $q \in \bQ$ such that $\pr^{\bs}(q \mid \varepsilon) > 0$, the following conditions hold:
\begin{enumerate}
\item For every $p \in \bP$$:$ $|\longest(q,p)| = 1$ 

\item There exists $I \subseteq \bP$ such that$:$
\begin{eqnarray}\label{eq-max-set}
\longest(q) & = & \bigcup_{p \in I} \longest(q,p).
\end{eqnarray}
Moreover, if $q \neq \{\varepsilon\}$, then there exists a unique $I \subseteq \longest(q,p)$ such that \eqref{eq-max-set} holds.
\end{enumerate}
\end{mylem}

\begin{proof}
Let $S = \{ q \in \bQ \mid \pr^{\bs}(q \mid \varepsilon) > 0 \}$. Then we have that $S$ is the smallest subset of $\bQ$ satisfying the following conditions:
\begin{itemize}
\item $\{\varepsilon\} \in S$.

\item If $p \in \bP$, $b \in \bB$, $q \in S$ and $\mine(p,b,q)$ is a greedy action, then $q \cup \{ b \cdot p\} \in S$.
\end{itemize}
Hence, we have an inductive definition of $S$, and we can prove the lemma by induction on the structure of this set of states. If $q = \{ \varepsilon \}$, then we have that $\longest(q) = \{ \varepsilon \}$ and $\longest(q,p) = \{ \varepsilon \}$ for every $p \in \bP$. Thus, we have that  the two conditions in the lemma hold since $|\longest(q,p)| = 1$ for every $p \in \bP$, and $\longest(q) = \longest(q,0)$. Assume that the property holds for $q \in S$, and assume that $p \in \bP$, $b \in \bB$ and $\mine(p,b,q)$ is a greedy action. Then we need to prove that the conditions in the lemma hold for $q ' = q \cup \{b \cdot p \}$.

Given that $\mine(p,b,q)$ is a greedy action, we know that $\length(q,p) \leq |b| < |b \cdot p|$. Thus, we have that $\longest(q',p) = \{b \cdot p\}$ and, hence, $|\longest(q',p)| = 1$. Moreover, we have that for every $p' \in \bP$ such that $p' \neq p$, it holds that $\longest(q',p') = \longest(q,p')$ and, hence, $|\longest(q',p')| = 1$. Therefore, the first condition of the lemma is satisfied. To prove that there exists $I \subseteq \bP$ such that \eqref{eq-max-set} holds, we consider two cases.
\begin{itemize}
\item Assume that $b \in \longest(q)$. Then we have that $\longest(q') = \{ b \cdot p \}$ and, hence, there exists $I \subseteq \bP$ such that \eqref{eq-max-set} holds since $\longest(q') = \longest(q',p)$.

\item Assume that $b \not\in \longest(q)$. By induction hypothesis we know that:
\begin{eqnarray*}
\longest(q) & = & \bigcup_{p' \in I} \longest(q,p').
\end{eqnarray*}
Given that $b \not\in \longest(q)$, we have that $p \not\in I$. Therefore,  for every $p' \in I$ we have that $\longest(q,p') = \longest(q',p')$. Hence, we deduce that:
\begin{eqnarray}\label{eq-lem-length-greedy}
\longest(q) & = & \bigcup_{p' \in I} \longest(q',p').
\end{eqnarray}
Let $k$ be the length of an arbitrary element in $\longest(q)$ (all the elements of this set have the same length). If $|p \cdot b| < k$, then $\longest(q') = \longest(q)$. Thus, from \eqref{eq-lem-length-greedy} we conclude that there exists $I \subseteq \bP$ such that \eqref{eq-max-set} holds since:
\begin{eqnarray*}
\longest(q') & = & \bigcup_{p' \in I} \longest(q',p').
\end{eqnarray*}
Assume now that $|p \cdot b| = k$. In this case, we have that $\longest(q') = \longest(q) \cup \{p \cdot b\}$. Thus,  from \eqref{eq-lem-length-greedy} and the fact that $\longest(q',p) = \{b \cdot p\}$, we conclude that:
\begin{eqnarray*}
\longest(q') & = & \bigg(\bigcup_{p' \in I} \longest(q',p')\bigg) \cup \longest(q',p)\\
& = & \bigcup_{p' \in I \cup \{p\}} \longest(q',p').
\end{eqnarray*}
Hence, in the case that $|p \cdot b| = k$, there also exists $I \subseteq \bP$ such that \eqref{eq-max-set} holds.
\end{itemize}
To conclude the proof of the lemma, we assume that $q' \neq \{\varepsilon\}$ and prove that there exists a unique $I \subseteq \bP$ such that \eqref{eq-max-set} holds. For the sake of contradiction, assume that there exist distinct $I_1, I_2 \subseteq \bP$ such that 
$\longest(q') = \bigcup_{p \in I_1} \longest(q',p) = \bigcup_{p \in I_2} \longest(q',p)$. 
Without loss of generality, assume that there exists $p_1 \in I_1$ such that $p_1 \not\in I_2$. Given that $q' \neq \{\varepsilon\}$, we have that $\varepsilon \not\in \longest(q')$. 
Let $b \in \longest(q',p_1)$. Given that $p_1 \in I_1$, we have that $b \neq \varepsilon$, from which we conclude that $\owner(b) = p_1$. Given that 
$ \bigcup_{p \in I_1} \longest(q',p) = \bigcup_{p \in I_2} \longest(q',p)$ and $p_1 \not\in I_2$, we conclude that there exists $p_2 \neq p_1$ such that $p_2 \in I_2$ and $b \in \longest(q',p_2)$, which leads to a contradiction since $b \neq \varepsilon$ and $\owner(b) \neq p_2$. This concludes the proof of the lemma.

\end{proof}

%
%
%
%We can use Lemma \ref{lem-length-greedy} to simplify the definition of greedy actions. More specifically, assume that $p \in \bP$ and $q \in \bQ$, and from now let $\longest(q,p)$ be a string instead of a singleton set. Then the conditions in Definition \ref{def-greedy} for a valid action $\mine(p,b,q)$ can be restated as follows:
%\begin{itemize}
%\item If $\bchain(q)$ is defined, then $|\longest(q,p)| \leq |b|  \leq |\bchain(q)|$. In particular, 
%if $q = \{\varepsilon\}$ or $\owner(\bchain(q)) = p$, then $b = \bchain(q)$ (and, thus, $p$ attempts to mine either in the genesis block if the game is starting or in the last block of the blockchain as in this case this block is hers).
%
%
%
%\item If $\bchain(q)$ is not defined, then there exists a unique $I$ such that \eqref{eq-max-set} holds, and we have that $b = \longest(q,p)$ for some $p \in I$.
%\end{itemize}
%


%\subsubsection{Key lemma: optimal strategies only depend on what follows the last block on the blockchain}

As a second key property of greedy combined strategies, we show that a regular condition can be imposed on equilibria. More precisely, given a state $q \in \bQ$, define $\ameet(q)$ as follows:
\begin{multline*}
\ameet(q)  \, =  \, \max_{\preceq} \ \{b \in q \mid \text{for every } p\in \bP \text{ and for every } b' \text{ such that } |b'| \geq \length(q,p): b \preceq b'\}. 
\end{multline*}
Moreover, given a block $b \in q$, define $\subbody(q,b)$ as the following state:
\begin{eqnarray*}
\subbody(q,b) & = & \{ b' \in \bB \mid b \cdot b' \in q\}.
\end{eqnarray*}

Finally, define $\base(q) = \subbody(q,\ameet(q))$.
%and $\base(\bQ) = \{q \in \bQ \mid q = \base(q)\} = \{q \in \bQ \mid \ameet(q) = \varepsilon \}$.
Then the following lemma states that optimal strategies (at least from the point of view of a single player) must be regular, in the sense that the same move can be made on any pairs of state $q$ and $q'$ with the same base. More precisely, 
%---------- weaker version --------------
a strategy $s$ for a player $p$ is \emph{basic} if for every pair of states $q, q'$ such that $\base(q) = \base(q')$, it holds that $s(q) = s(q')$. Then we have that:

\begin{mylem}
\label{lem-basic}
Let $p \in \{1, \ldots, m\}$ and $\bs$ be a combined greedy strategy such that $s_j$ is a basic strategy for every player $j \neq p$. Then there exists a basic strategy $s'_p$ for player $p$ such that $(\bs_{-p}, s'_p)$ is a greedy combined strategy and $u_p((\bs_{-p},s'_p) \mid \varepsilon) \geq u_p((\bs_{-p},s_p) \mid \varepsilon)$.
\end{mylem}

\newcommand{\succes}{\text{succ}}
\newcommand{\cut}{\text{cut}}
\newcommand{\replace}{\text{replace}}

Let us denote by $\cut(q,\ameet(q))$ the set $\{b \mid b \in q, \ameet(q) \not \preceq b\}$, i.e., the result of 
removing from $q$ all states that are successors of $\ameet(q)$, including $\ameet(q)$ itself. 

Consider a strategy $s_p$ and a set $s_{-p}$ of basic strategies. We build $s'_p$ by repeatedly replacing actions as follows. 
For each state $q_a$ such that $s_p(q_a) \neq s_p(\base(q_a))$, let 
$s_p[\base \rightarrow a]$ be defined as: 
$$s_p[\base \rightarrow a](q) = \begin{cases}
\base(s(q_a)), \text{ if } q = \base(q_a); \\
s(q) \text{ otherwise }
\end{cases}
$$ 
Moreover, denote by $A$ the set of states given by 
$\{q \in \bQ \mid \}$

and let $s_p[a \rightarrow \base]$ be defined as: 
$$s_p[a \rightarrow \base](q) = \begin{cases}
\cut(q,\ameet(q)) \cup s(\base(q_a)), \text{ if } \base(q) = \base(q_a); \\
\cut(q,\ameet(q)) \cup s(q_a), \text{ if } \replace(q,\ameet(q),q_a); \\
s(q) \text{ otherwise }
\end{cases}
$$ 
Define also $\bs[\base \rightarrow a] = 
(s_{-p}, s_p[\base \rightarrow a])$. 



%%%% need: replace, read and make better, convergence. 

We have three cases. \textbf{First}, if $u_p(\bs[\base \rightarrow a] \mid \base(q_a)) > u_p(\bs \mid \base(q_a))$. In this case it is easy to see 
that strategy $\bs[\base \rightarrow a]$ has a higher utility on $\epsilon$ than $\bs$. We then set $s'_p(q') = s_p[\base \rightarrow a]$. 

\textbf{Second}, if $u_p(\bs[\base \rightarrow a] \mid \base(q_a)) < u_p(\bs \mid \base(q_a))$. In this case 
the strategy $\bs[a \rightarrow \base]$ has a higher utility on $\epsilon$ than $\bs$. To see this, let $\bQ^a$ be the 
set of all states $q$ such that $\pr^\bs(q \mid q_a) > 0$. Then the utility of 

$$u_p(\bs \mid \epsilon) = \sum_{q \notin \bQ^a} \beta^{|q|} r_p(q) \pr^\bs(q \mid \epsilon) + 
\beta^{|q_a|} u_p(\bs \mid q_a) \pr^\bs(q_a \mid \epsilon), $$
and where $u_p(\bs \mid q_a)$ can be rewritten as $r_p(q_a) + \alpha^{|\ameet(q_a)|}u_p(\bs[\base \rightarrow a] \mid \base(q_a))$. 

On the other hand, 
$$u_p(\bs[a \rightarrow \base] \mid \epsilon) = \sum_{q \notin \bQ^a} \beta^{|q|} r_p(q) \pr^{\bs[a \rightarrow \base]}(q \mid \epsilon) + 
\beta^{|q_a|} u_p(\bs[a \rightarrow \base] \mid q_a) \pr^{\bs[a \rightarrow \base]}(q_a \mid \epsilon), $$
and where $u_p(\bs[a \rightarrow \base] \mid q_a)$ can be rewritten as $r_p(q_a) + \alpha^{|\ameet(q_a)|}u_p(\bs \mid \base(q_a))$, 
which shows our claim  $u_p(\bs[\base \rightarrow a] \mid \base(q_a)) < u_p(\bs \mid \base(q_a))$. 

We then set $s'_p(q') = s_p[a \rightarrow \base]$. 

\textbf{Third}, if $u_p(\bs[\base \rightarrow a] \mid \base(q_a)) = u_p(\bs \mid \base(q_a))$, we do not modify $s'$ for this state. 

Let us note that each modification produces a strategy with an equal or higher utility, and where any state $q$ where 
$\base(s(q)) \neq \base(s\base(q))$ is farther and farther away from $\epsilon$, in terms of the size of blocks. 
Then the limit of this modification satisfies the claim 




%we claim that 
%the strategy $\bs[\base \rightarrow a]$ has a higher utility on $\epsilon$ than $\bs$. Let $\bQ'$ contain all states 
%$q'$ such that $\base(q') = \base(q_a)$ and $\base(s(q')) = \base(s(\base(q_a)))$, and let $\bQ'_{min}$ denote the set of minimal such states, 
%that is, $\bQ'_{min} = \{q \mid q \in \bQ'$ and for every $q``\in \bQ', \pr^\bs(q \mid q'') = 0\}$. 
%Finally, $\succ(\bQ'_{min})$ denotes all states that are successors of a state in $\bQ'_{min}$. 

%Now the utility of 
%$u_p(\bs \mid \epsilon)$ can be written as $\sum_{q \notin \succ(\bQ'_{min})} r_p(q) \pr^\bs(q \mid \epsilon)$ + 
%$\sum_{i = 0}^\infty \sum_{q \in \bQ'_{min}, |q| = i} u_p( \bs \mid q) \pr^\bs(q \mid \epsilon)$. 

%If we change $\bs$ for $\bs[\base \rightarrow a])$, the first sum above remains the same, and in the second sum 
%all that changes is $u(\bs \mid q)$ for $u(\bs[\base \rightarrow a] \mid q)$. Thus, all that is left to show is that 
%$u(\bs \mid q) < u(\bs[\base \rightarrow a] \mid q)$ for $q \in \bQ'_{min}$. 

%Assume first that $\pr^\bs(q \mid q_a) = 0$. Then 
%$u_p(\bs \mid q) = r_p(q) + \alpha^{\ameet(q)} u_p(\bs \mid \base(q))$, because by our assumption the strategy in 
%$q$ corresponds to that of $\base(q)$. Furthermore, 
%$u_p(\bs[\base \rightarrow a] \mid q) = r_p(q) + \alpha^{\ameet(q)} u_p(\bs[\base \rightarrow a] \mid \base(q))$, 
%and we obtain what we need. 


%Assume the contrary: then 
%$u(\bs \mid q) \geq u(\bs[\base \rightarrow a] \mid q)$


%$u_p(\bs[\base \rightarrow a] \mid q_a) > u_p(\bs \mid q_a)$


%\newcommand{\cut}{\text{cut}}
%Now let us denote by $\cut(q,\ameet(q))$ the set $\{b \mid b \in q, \ameet(q) \not \preceq b\}$, i.e., the result of 
%removing from $q$ all states that are successors of $\ameet(q)$, including $\ameet(q)$ itself. 
%Since $s_p$ is greedy, Lemma \ref{lem-meet1} and the fact 
%that $s_{-p}$ are all basic, we can replace $u_p(\bs \mid q)$ for 
%$r_p(\cut(q,\ameet(q)))+ \alpha^{\ameet(q)}u(\bs \mid \base(q))$.

%So we have that 

%$$u_p(\bs \mid \epsilon) = \sum_{q \notin \succ(\bQ'_{min})} r_p(q) \pr^\bs(q \mid \epsilon) + 
%\sum_{i = 0}^\infty \sum_{q \in \bQ'_{min}, |q| = i} [r_p(\cut(q,\ameet(q)))+ \alpha^{\ameet(q)}u(\bs \mid \base(q))] \pr^\bs(q \mid \epsilon).$$ 

%Now if we change $\bs$ for $\bs[\base \rightarrow a])$, the first sum above remains the same, and in the second sum 
%all that changes is $u(\bs \mid \base(q))$ for $u(\bs[\base \rightarrow a] \mid \base(q))$. 
%Thus, all that is left to show is that $u(\bs \mid \base(q)) < u(\bs[\base \rightarrow a] \mid \base(q))$. 

%are 

% is strictly 
%greater than $u_p(q' \mid \bs)$. 

%We then set $s'_p(q') = s_p[\base \rightarrow a]$. 

%\smallskip

%Next, if $u_p(\bs[\base \rightarrow a] \mid q_a) > u_p(\bs \mid q_a)$, let $\bs[a \rightarrow \base]$ be the strategy such that 
%$s_p[a \rightarrow \base](q_a) = s(q)$ 




%Define $\bQ_A = \{q \mid \pr^s(q \mid q_a) > 0\}$ 

%Now $$u_p( s \mid q) = \sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} u_p(s \mid q^*) * \pr^s(q^* \mid q), $$



%We need a first few key results. First is an easy observation about the meet of states. 
%\begin{mylem}
%	\label{lem-meet1}
%	Let $\bs$ be a combined greedy strategy. Then for every pair $q$ and $q'$ of states such that 
%	$\pr^{\bs'}(q' \mid q) \neq 0$ we have that $\ameet(q) \preceq \meet(q')$
%\end{mylem}	
%\begin{proof}
%Since for any state $q$ it holds that $\ameet(q) \preceq \meet(q)$, it suffices to show that $\ameet(q) \preceq \ameet(q')$. 
%The proof is by induction on the number of extra blocks in $q'$. 

%Take a state $q'$ such that $\pr^{\bs'}(q' \mid q) \neq 0$, and consider the state $q''$ such that $q' = s_p(q'')$, for some player 
%$p$ (such state must exist because $\pr^{\bs'}(q' \mid q) \neq 0$). By induction we have that 
%$\ameet(q) \preceq \ameet(q'')$, and since $s_p$ is greedy, the only valid actions involve mining something after $\ameet(q'')$, so that 
%$\ameet(q) \preceq \ameet(s_p(q''))$.
%\end{proof}

%With this lemma, we can

\subsection{Some basic properties of the utility function}
Let $q, q' \in \bQ$ be two states such that $q \subseteq q'$, and let $Q \subseteq \bQ$. We say that a sequence of states $q_1$, $\ldots$, $q_n$ is a path from $q$ to $q'$ if $n \geq 1$, $q_1 = q$, $q_n =q'$, $q_i \subseteq q_{i+1}$ and $|q_{i+1}| - |q_i| = 1$ for every $i \in \{1, \ldots, n-1\}$. Moreover, we say that path $q_1$, $\ldots$, $q_n$ crosses $Q$ if there exists $i \in \{1, \ldots, n\}$ such that $q_i \in Q$. Finally, we define the down- and up-closures of $Q$ as follows:
\begin{eqnarray*}
\dcl(Q) &=& \{ q \in \bQ \mid \text{there exists } q' \in Q \text{ such that } q \subseteq q'\},\\
\ucl(Q) &=& \{ q \in \bQ \mid \text{there exists } q' \in Q \text{ such that } q' \subseteq q\}.
\end{eqnarray*}
We use the previous notation to define when a set of states is a cut. More precisely, assuming that $Q \subseteq \bQ$ and $q_0 \in \dcl(Q)$, we say that $Q$ is a cut for $q_0$ if:
\begin{itemize}
\item for every $q_1, q_2 \in Q$, it holds that $q_1 \not\subseteq q_2$ and $q_2 \not\subseteq q_1$ (that is, $q_1$ and $q_2$ are incomparable states), and

\item for every $q \in \ucl(Q)$ such that $q \subseteq q'$ and for every path $q_1$, $\ldots$, $q_n$ from $q$ to $q'$, it holds that $q_1$, $\ldots$, $q_n$ crosses $Q$.
\end{itemize}

\begin{mylem}\label{lem-cut}
Let $Q \subseteq \bQ$ and $q_0 \in \dcl(Q)$ such that $Q$ is a cut for $q$, and let $\bs$ be a combined strategy. Then for every state $q \in \ucl(Q)$, it holds that:
\begin{eqnarray*}
\pr^{\bs}(q \mid q_0) & = & \sum_{q' \in Q} \pr^{\bs}(q \mid q') \cdot \pr^{\bs}(q' \mid q_0).
\end{eqnarray*}
\end{mylem}

\begin{proof}
Direct from the definition of the notion of cut.
\end{proof}

\begin{mylem}\label{lem-cut-utility}
Given $p \in \bP$, a combined strategy $\bs$, $q_0 \in \bQ$ and $Q \subseteq \bQ$ such that $Q$ is a cut for $q_0$, it holds that:
\begin{multline*}
u_p(\bs \mid q_0) \ = \\
\sum_{q \in \bQ \smallsetminus \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \pr^{\bs}(q \mid q_0) + 
\sum_{q \in Q \,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot \pr^{\bs}(q \mid q_0) \cdot u_p(\bs \mid q)
\end{multline*}
\end{mylem}

\begin{proof} We have that: 
\begin{align*}
&u_p(\bs \mid q_0) =\\
&\hspace{10pt} \sum_{q \in \bQ \,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \pr^{\bs}(q \mid q_0) =\\
&\hspace{10pt} \sum_{q \in \bQ \smallsetminus \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \pr^{\bs}(q \mid q_0) + 
\sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \pr^{\bs}(q \mid q_0)
\end{align*}
Given that $Q$ is a cut for $q_0$, we conclude from Lemma \ref{lem-cut} that:
\begin{align*}
&\sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \pr^{\bs}(q \mid q_0) =\\
&\hspace{100pt} \sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \bigg(\sum_{q' \in Q} \pr^{\bs}(q \mid q') \cdot \pr^{\bs}(q' \mid q_0)\bigg) =\\
&\hspace{100pt} \sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q} \bigg(\sum_{q' \in Q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q') \cdot \pr^{\bs}(q' \mid q_0)\bigg) =\\
&\hspace{100pt}  \sum_{q' \in Q} \pr^{\bs}(q' \mid q_0) \cdot \bigg(\sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q')\bigg) 
\end{align*}
Moreover, given that $\pr^{\bs}(q_2 \mid q_1) = 0$ if $q_1 \not\subseteq q_2$, we conclude that
\begin{align*}
& \sum_{q' \in Q} \pr^{\bs}(q' \mid q_0) \cdot \bigg(\sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q')\bigg) =\\
& \hspace{30pt}\sum_{q' \in Q \,:\, q_0 \subseteq q'} \pr^{\bs}(q' \mid q_0) \cdot \bigg(\sum_{q \in \bQ \cap \ucl(Q)\,:\, q_0 \subseteq q \text{ and } q' \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q')\bigg)  =\\
&\hspace{30pt} \sum_{q' \in Q \,:\, q_0 \subseteq q'} \pr^{\bs}(q' \mid q_0) \cdot \bigg(\sum_{q \in \bQ \cap \ucl(Q)\,:\, q' \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q')\bigg)  =\\
&\hspace{30pt} \sum_{q' \in Q \,:\, q_0 \subseteq q'} \pr^{\bs}(q' \mid q_0) \cdot \bigg(\sum_{q \in \bQ \,:\, q' \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q')\bigg)  =\\
&\hspace{30pt} \sum_{q' \in Q \,:\, q_0 \subseteq q'} \beta^{|q'|-|q_0|} \cdot \pr^{\bs}(q' \mid q_0) \cdot \bigg(\sum_{q \in \bQ \,:\, q' \subseteq q} \beta^{|q|-|q'|} \cdot r_p(q) \cdot  \pr^{\bs}(q \mid q')\bigg)  =\\
&\hspace{20pt} \sum_{q' \in Q \,:\, q_0 \subseteq q'} \beta^{|q'|-|q_0|} \cdot \pr^{\bs}(q' \mid q_0) \cdot u_p(\bs \mid q')
\end{align*}
Therefore, from the previous calculations we conclude that:
\begin{multline*}
u_p(\bs \mid q_0) \ = \\
\sum_{q \in \bQ \smallsetminus \ucl(Q)\,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot r_p(q) \cdot \pr^{\bs}(q \mid q_0) + 
\sum_{q \in Q \,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot \pr^{\bs}(q \mid q_0) \cdot u_p(\bs \mid q)
\end{multline*}
\end{proof}
From Lemma \ref{lem-cut-utility}, we obtain the following useful corollaries: 

\begin{mycor}\label{cor-cut-1}
Given $p \in \bP$, a combined strategy $\bs$, $q_0 \in \bQ$ and $Q \subseteq \bQ$ such that $Q$ is a cut for $q_0$, if $\pr^{\bs}(q \mid q_0) = 0$ for every state $q$ such that $q \in \bQ \smallsetminus \ucl(Q)$ and $q_0 \subseteq q$, then it holds that:
\begin{eqnarray*}
u_p(\bs \mid q_0) & = &
\sum_{q \in Q \,:\, q_0 \subseteq q} \beta^{|q|-|q_0|} \cdot \pr^{\bs}(q \mid q_0) \cdot u_p(\bs \mid q)
\end{eqnarray*}
\end{mycor}

\begin{mycor}\label{cor-dist-k}
Given $p \in \bP$, a combined strategy $\bs$, a state $q_0 \in \bQ$ and $k \geq 1$, it holds that:
\begin{multline*}
u_p(\bs \mid q_0) \ = \  
\sum_{i=0}^{k-1} \beta^i \cdot \bigg(\sum_{\substack{q \in \bQ \,: \\ q_0 \subseteq q \text{ {\rm and} } |q| - |q_0| = i}}
r_p(q) \cdot \pr^{\bs}(q \mid q_0)\bigg) \ + \\
\beta^k \cdot 
\bigg(\sum_{\substack{q \in \bQ \,: \\ q_0 \subseteq q \text{ {\rm and} } |q| - |q_0| = k}}
\pr^{\bs}(q \mid q_0) \cdot u_p(\bs \mid q)\bigg).
\end{multline*}
\end{mycor}

\begin{proof} 
This result is obtained by considering $Q = \{ q \in \bQ \mid q_0 \subseteq q$ and  $|q| - |q_0| = k \}$ in Lemma \ref{lem-cut-utility}, which is a cut for $q_0$.
\end{proof}


\subsection{Proof of Theorem \ref{thm-conts_equlibria}} 

Let $p \in \bP$ a player and $s_p$ a greedy strategy for player $p$. We need to show that 
$u_p(\bdf \mid \varepsilon) \geq u_p( (\df_{-p},s_p) \mid \varepsilon)$. The first remark is that without loss of generality we can consider 
$m = 2$, because when comparing these two strategies we can bundle together all the remaining players, behaving according to the default strategy
under the combined hash power given by the sum of all the $h_j$'s for $j \neq p$. We thus focus on the strategies 
$\bdf = (\df_0,\df_1)$ and $\bs = (\df_0,s_p)$, and for readability we assume that $p = 1$, so that $\bs = (\df_0,s_1)$.
Moreover, by Lemma \ref{lem-basic}, we can also assume that $s_1$ is a basic strategy, 
%satisfies the properties of this Lemma, 
that is, for every  pair of states $q$ and $q'$ such that $\base(q) = \base(q')$ we have that $s_1(q) = s_1(q')$.

Assume for the sake of contradiction that $u_1(\bdf \mid \varepsilon) < u_1( \bs \mid \varepsilon)$. Then there must be at least one 
state $q$ such that $s_1(q) \neq \df_1(q)$, the probability $\pr^{\bs}(q \mid \varepsilon)$ of eventually reaching this state is greater than $0$, and $u_1(\bdf \mid q) < u_1(\bs \mid q)$. 







Now, because of Lemma \ref{lem-basic}, we assume without loss of generality that in state $q$, player $p$ has $0$ blocks on the blockchain. Further, from all such states satisfying all these requirements, we take the one with the fewer number of blocks. Because our actions are greedy, we know that state $q$ has the shape of a line of $m$ blocks, all owned by player $0$. 

Let us now do some calculations on both $u_p(\df \mid q)$ and $u_p( (\df_{-p},s_p) \mid q)$. 
\medskip

First, note that the payoff for player $p$ on $q$ is $0$, and it will continue to be $0$ until player $p$ manages to put at least one block in the blockchain. To that extent, let $s = (\df_{-p},s_p)$, and define the set 
$Q_p = \{q^* \in \bQ \mid \pr^s(q^* \mid q) > 0, $ and player $p$ has at least a block in the blockchain of $q^* \}$, 
and let $Q^*_p=\{q^* \in Q_p \mid$ for every other state $q' \in Q_p, \pr^s(q^* \mid q')=0 \}$ be the set of minimal states from $Q_p$; 
the idea is that states in $Q^*_p$ represent the first states, going from $q$, where $p$ has at least one block in the blockchain 
(it may be more than one block, if $p$ forked and the chain of the forking branch just became the blockchain). 
As mentioned, the reward for any block reachable from $q$ but not in $Q_p$ is $0$, and therefore we can rewrite the utility as

$$u_p( s \mid q) = \sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} u_p(s \mid q^*) * \pr^s(q^* \mid q), $$
and since the blockchain was just won in $q^*$, %(and by Lemma \ref{lem-meet} and because the strategies are greedy), 
this is equivalent to 
$$ \sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} \big(\sum_{j = 0}^\infty \beta^j r_p(q^*) + u_p(s \mid \varepsilon) \big) \pr^s(q^* \mid q), $$
this is again by Lemma \ref{lem-meet}: for the strategy we just need to consider the subtree rooted in the last block of the blockchain of $p$, and 
because the strategies are greedy (and our definition of reward), the difference in reward will always be given by $r_p(q^*)$. 

What will now map states from $Q^*_p$ to states reachable from $q$ but by using $\df_p$. We do it by constructing the following assignment $\sigma$.
Let $Q^\df$ be the states $q'$ such that $\pr^\df(q' \mid q) > 0$. 

Now for each state $q^* \in Q^*_p$, enumerate all distinct paths $\pi = q^*_0,\dots,q_n^*$ such that $q_{i+1}^*$ can be reached from 
$q_i^*$ in one step, $q = q_0^*$ and $q^* = q_n^*$. For each such path $\pi$, we can associate an $n$-bit string $a_1,\dots,a_n$, 
where $a_i = 1$ if the action to go from $q_{i-1}^*$ to $q_i^*$ was that player $1$ mined, and $0$ in case the action was that $0$ mined. 
Next, for each such path $\pi = a_1,\dots,a_n$, let $q_\pi$ be the state given by $q$, followed by a chain of $n$ blocks, where block $i$ is 
owned by player $a_i$. Then $\sigma(q^*) = \{q_{\pi_1},\dots,q_{\pi_\ell}\}$, where $\pi_1,\dots,\pi_\ell$ is an enumeration of the aforementioned paths. 

It is not hard to verify that $\sigma$ is well defined, and that none of 
the states in the image of this assignment can be reached from another. 

We then have that 
$$u_p( \df \mid q) \geq \sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} \sum_{q' \in \sigma(q^*)} 
u_p(\df \mid q')  \pr^\df(q' \mid q), $$

and by the same calculation that before, the right hand side of this inequality is 
$$\sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} \sum_{q' \in \sigma(q^*)}  \big(\sum_{j = 0}^\infty \beta^j r_p(q') + u_p(\df \mid \varepsilon)\big) \pr^\df(q' \mid q).$$

The reward for each block in $\sigma(q^*)$ in our case is the number of blocks in $q^*$, which is the maximum reward that a state could give. This means that $r_p(q') \geq r_p(q^*)$ for any state $q' \in \sigma(q^*)$. 
Furthermore,  by construction we have that 
$\sum_{q' \in \sigma(q^*)} \pr^\df(q' \mid q) = \pr^s(q^* \mid q)$, and thus 
$$\sum_{q' \in \sigma(q^*)} \big(\sum_{j = 0}^\infty \beta^j r_p(q') + u_p(\df \mid \varepsilon)\big) \pr^\df(q' \mid q) \geq \big(\sum_{j = 0}^\infty \beta^j r_p(q^*) + u_p(\df \mid \varepsilon)\big) \pr^s(q^* \mid q).$$ 
Summing up, we obtain: 

$$u_p( \df \mid q) \geq \sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} \big(\sum_{j = 0}^\infty \beta^j r_p(q^*) + u_p(\df \mid \varepsilon)\big)  \pr^s(q^* \mid q).$$

Let us now define $\df'_p$ as the strategy that imitates $\df$ until a state in the image of $\sigma(Q^*_p)$ is reached, after which 
we continue as with $s_p$. Let $s' = (\df_{-p},\df'_p)$. By the same calculations as before, 

$$u_p(s' \mid q) \geq \sum_{i=0}^\infty \beta^i \sum_{q^* \in Q^*_p, |q^*| = |q| + i} \big(\sum_{j = 0}^\infty \beta^j r_p(q^*) + u_p(s \mid \varepsilon)\big)  \pr^s(q^* \mid q), $$
and the right hand side of this inequality is precisely $u_p(s \mid q)$. This means that the utility for strategy $\df'_p$ is not lower than the utility of strategy $s_p$, for player $p$, assuming the rest of the players play according to $\df$. 

We can now repeat the same argument we have used but now starting with strategy $\df'_p$, which by our initial assumption must yield 
a bigger utility than $\df_p$. Note also that $\df_p(q) = \df_p'(q)$. 
Now, by cutting and pasting $\df'_p$ over and over again using the same argument as before, we end up with the fact that $\df_p$ yields 
a utility at least as big as $s_p$, which contradicts our initial assumption. 

+++ to show: the utility of this sequence converges to the utility of the default strategy +++



%New idea: for the proof of the other equilibrium, explain that utility of cow covers all cases with positive reward of any other utility forking. 
%for the equlibrium, we first do utility of doing a strategy over and over again by solving a recurrence relation. That is an over approximation for the utility of a player, see if anything can be done with that (previously we had an under aproximation). Regardless, it is good to calculate the utility of the complete strategy, not just forking once. 





\subsection{Combined strategies in Section \ref{sec-dec}}
In section \ref{sec-dec}, we calculate the utility of the following combined strategies.
\begin{itemize}
\item {\bf Fork on the genesis.} In this case, we consider the combined strategy $\fg = (\fg_0, \df_1$, $\ldots$, $\df_{m-1})$, where $\fg_0$ is defined as follows for a state $q \in \bQ$:
\begin{eqnarray*}
\fg_0(q) & = &
\begin{cases}
\mine(0,\varepsilon,q) & \text{if } 0 \not\in q\\
\df_0(q) & \text{if } \bchain(q) \text{ is defined and } 0 \preceq \bchain(q)\\
\mine(0,\longest(q,0),q) &  \text{otherwise}
\end{cases}
\end{eqnarray*}

\item {\bf Fork on the genesis with give up time.} Given a natural number $k \geq 1$, in this case, we consider the combined strategy $\fg_k = (\fg_{0,k}, \df_1$, $\ldots$, $\df_{m-1})$, where $\fg_{0,k}$ is defined as follows for a state $q \in \bQ$:
\begin{eqnarray*}
\fg_{0,k}(q) & = &
\begin{cases}
\mine(0,\varepsilon,q) & \text{if } 0 \not\in q,\ \bchain(q) \text{ is defined and } |\bchain(q)| \leq k\\
\mine(0,b,q) & \text{if } 0 \not\in q,\ \bchain(q) \text{ is defined, } |\bchain(q)| > k \text{ and }\\
& \hspace{51pt} b \preceq \bchain(q) \text{ such that } |b| = |\bchain(q)|-k+1\\
\df_0(q) & \text{if } \bchain(q) \text{ is defined and}\\
& \hspace{9pt} \text{there exists } i \in \{1, \ldots, m\} \text{ such that } \bchain(q)[i] = 0\\
\mine(0,\longest(q,0),q) &  \text{otherwise}
\end{cases}
\end{eqnarray*}

\end{itemize}

\subsection{Aditonal notation}

\begin{mylem}\label{lem-new-state}
Let $q$ a state and $q' = \subbody(\meet(q,p),q)$. 
\end{mylem}


%\begin{mylem}\label{lem-dist-1}
%Given $p \in \bP$, a combined strategy $\bs$ and $\bq_0 \in \bQ$, it holds that:
%\begin{eqnarray*}
%u_p(\bs \mid \bq_0) & = & r_p(\bq_0) +  \beta \cdot 
%\bigg(\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = 1}}
%\pr(\bq \mid \bq_0) \cdot u_p(\bs \mid \bq)\bigg).
%\end{eqnarray*}
%\end{mylem}
%
%\begin{proof} We have that:
%\begin{align*}
%u_p(\bs \mid & \ \bq_0)  \ =  \\
%&\sum_{i=0}^{\infty}\beta^{i} \cdot  \bigg(\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = i}} r_p(\bq) \cdot 
%\pr^{\bs}(\bq \mid \bq_0)\bigg) \ =\\
%& r_p(\bq_0) + \sum_{i=1}^{\infty}\beta^{i} \cdot  \bigg(\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = i}} r_p(\bq) \cdot 
%\pr^{\bs}(\bq \mid \bq_0)\bigg)\ = \\
%& r_p(\bq_0) + \sum_{i=1}^{\infty}\beta^{i} \cdot  \bigg(
%\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = 1}} \pr^{\bs}(\bq \mid \bq_0) \cdot
%\bigg(\sum_{\substack{\bq' \in \bQ \,: \\ \bq \subseteq \bq' \text{ {\rm and} } |\bq'| - |\bq| = i-1}} r_p(\bq) \cdot 
%\pr^{\bs}(\bq' \mid \bq)\bigg)\bigg)\ = \\
%& r_p(\bq_0) + \beta \cdot \sum_{i=1}^{\infty}\beta^{i-1} \cdot  \bigg(
%\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = 1}} \pr^{\bs}(\bq \mid \bq_0) \cdot
%\bigg(\sum_{\substack{\bq' \in \bQ \,: \\ \bq \subseteq \bq' \text{ {\rm and} } |\bq'| - |\bq| = i-1}} r_p(\bq) \cdot 
%\pr^{\bs}(\bq' \mid \bq)\bigg)\bigg)\ = \\
%& r_p(\bq_0) + \beta \cdot \sum_{j=0}^{\infty}\beta^{j} \cdot  \bigg(
%\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = 1}} \pr^{\bs}(\bq \mid \bq_0) \cdot
%\bigg(\sum_{\substack{\bq' \in \bQ \,: \\ \bq \subseteq \bq' \text{ {\rm and} } |\bq'| - |\bq| = j}} r_p(\bq) \cdot 
%\pr^{\bs}(\bq' \mid \bq)\bigg)\bigg)\ = \\
%& r_p(\bq_0) + 
% \beta \cdot \bigg(\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = 1}} \pr^{\bs}(\bq \mid \bq_0) \cdot \bigg(\sum_{j=0}^{\infty}\beta^{j} \cdot  \bigg(\sum_{\substack{\bq' \in \bQ \,: \\ \bq \subseteq \bq' \text{ {\rm and} } |\bq'| - |\bq| = j}} r_p(\bq) \cdot 
%\pr^{\bs}(\bq' \mid \bq)\bigg)\bigg)\bigg)\ = \\
%& r_p(\bq_0) +  \beta \cdot 
%\bigg(\sum_{\substack{\bq \in \bQ \,: \\ \bq_0 \subseteq \bq \text{ {\rm and} } |\bq| - |\bq_0| = 1}}
%\pr(\bq \mid \bq_0) \cdot u_p(\bs \mid \bq)\bigg).
%\end{align*}
%\end{proof}





